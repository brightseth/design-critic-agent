<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NINA - AI Art Curator [FIXED]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 20px 30px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 100;
            letter-spacing: 8px;
        }

        .tagline {
            font-size: 11px;
            color: #666;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Persistent Workspace */
        .workspace {
            background: #0a0a0a;
            border-bottom: 1px solid #222;
            padding: 20px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .workspace-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #888;
        }

        .workspace-count {
            color: #4CAF50;
            margin-left: 10px;
        }

        .workspace-actions {
            display: flex;
            gap: 10px;
        }

        .workspace-thumbnails {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            min-height: 100px;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            border: 2px solid #222;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
            background: #111;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail.selected {
            border-color: #4CAF50;
        }

        .thumbnail-score {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: #4CAF50;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
        }

        .workspace-empty {
            width: 100%;
            height: 80px;
            border: 2px dashed #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
        }

        .add-images-thumb {
            border: 2px dashed #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 24px;
            background: transparent;
            transition: all 0.3s;
        }

        .add-images-thumb:hover {
            border-color: #666;
            color: #999;
        }

        /* Pipeline Navigation */
        .pipeline {
            background: #111;
            padding: 30px;
            border-bottom: 1px solid #222;
        }

        .pipeline-steps {
            display: flex;
            justify-content: center;
            gap: 40px;
            align-items: center;
        }

        .pipeline-step {
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .pipeline-step.active {
            color: #4CAF50;
        }

        .pipeline-step.completed::after {
            content: '✓';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: #4CAF50;
            font-size: 12px;
        }

        .step-number {
            display: block;
            font-size: 10px;
            color: #666;
            margin-bottom: 5px;
        }

        .step-name {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .step-count {
            display: block;
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }

        .step-arrow {
            color: #333;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        /* Buttons */
        .btn {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 20px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 11px;
            transition: all 0.3s;
        }

        .btn:hover {
            border-color: #666;
        }

        .btn-primary {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed #333;
            padding: 60px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: #666;
        }

        .upload-zone.dragover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: #111;
            border: 1px solid #222;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-card:hover {
            border-color: #444;
        }

        .result-card.selected {
            border-color: #4CAF50;
        }

        .result-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .result-info {
            padding: 15px;
        }

        .result-score {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .score-high { color: #4CAF50; }
        .score-medium { color: #FFC107; }
        .score-low { color: #f44336; }

        .result-verdict {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
        }

        /* Status Bar */
        .status-bar {
            background: #0a0a0a;
            border-top: 1px solid #222;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #111;
            border: 1px solid #333;
            padding: 15px 20px;
            border-radius: 4px;
            max-width: 300px;
            animation: slideIn 0.3s;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .notification.success {
            border-color: #4CAF50;
        }

        .notification.error {
            border-color: #f44336;
        }

        /* Compare Mode */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
        }

        .compare-image {
            text-align: center;
        }

        .compare-image img {
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
        }

        .compare-score {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <div class="logo">NINA</div>
            <div class="tagline">Brutally Selective AI Curation</div>
        </div>
        <div>
            <a href="/beta.html" style="color: #444; text-decoration: none; font-size: 11px;">Beta Features →</a>
        </div>
    </div>

    <!-- Persistent Workspace -->
    <div class="workspace">
        <div class="workspace-header">
            <div>
                <span class="workspace-title">Workspace</span>
                <span class="workspace-count" id="workspaceCount">0</span>
            </div>
            <div class="workspace-actions">
                <button class="btn btn-small btn-primary" onclick="addToWorkspace()">+ Add Images</button>
                <button class="btn btn-small" onclick="clearWorkspace()">Clear All</button>
            </div>
        </div>
        <div class="workspace-thumbnails" id="workspaceThumbnails">
            <div class="workspace-empty" id="workspaceDropZone">
                <span style="font-size: 12px; color: #666;">Drop images here or click + Add Images</span>
            </div>
        </div>
        <input type="file" id="workspaceFileInput" multiple accept="image/*" style="display: none;">
    </div>

    <!-- Pipeline Navigation -->
    <div class="pipeline">
        <div class="pipeline-steps" id="pipelineSteps">
            <div class="pipeline-step active" onclick="switchMode('evaluate')">
                <span class="step-number">01</span>
                <span class="step-name">Evaluate</span>
                <span class="step-count" id="evaluateCount"></span>
            </div>
            <span class="step-arrow">→</span>
            <div class="pipeline-step" onclick="switchMode('compare')">
                <span class="step-number">02</span>
                <span class="step-name">Compare</span>
                <span class="step-count" id="compareCount"></span>
            </div>
            <span class="step-arrow">→</span>
            <div class="pipeline-step" onclick="switchMode('collect')">
                <span class="step-number">03</span>
                <span class="step-name">Collect</span>
                <span class="step-count" id="collectCount"></span>
            </div>
            <span class="step-arrow">→</span>
            <div class="pipeline-step" onclick="switchMode('optimize')">
                <span class="step-number">04</span>
                <span class="step-name">Optimize</span>
                <span class="step-count" id="optimizeCount"></span>
            </div>
            <span class="step-arrow">→</span>
            <div class="pipeline-step" onclick="switchMode('review')">
                <span class="step-number">05</span>
                <span class="step-name">Review</span>
                <span class="step-count" id="reviewCount"></span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- EVALUATE Mode -->
        <div class="mode-content active" id="evaluateContent">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Evaluate Images</h2>
                <div>
                    <button class="btn btn-primary" onclick="evaluateAll()" id="evaluateBtn">Evaluate All</button>
                    <button class="btn" onclick="moveTopToCompare()" id="compareTopBtn" style="display: none;">Compare Top →</button>
                </div>
            </div>
            <div id="evaluateResults" class="results-grid">
                <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #666;">
                    Add images to workspace above to begin evaluation
                </div>
            </div>
        </div>

        <!-- COMPARE Mode -->
        <div class="mode-content" id="compareContent">
            <h2>Compare Top Performers</h2>
            <div id="compareContainer"></div>
            <div id="compareWinners" class="results-grid" style="margin-top: 40px;"></div>
        </div>

        <!-- COLLECT Mode -->
        <div class="mode-content" id="collectContent">
            <h2>Build Collection</h2>
            <div id="collectionGrid" class="results-grid"></div>
            <button class="btn btn-primary" onclick="saveCollection()" style="margin-top: 30px;">Save Collection</button>
        </div>

        <!-- OPTIMIZE Mode -->
        <div class="mode-content" id="optimizeContent">
            <h2>Optimize Prompts</h2>
            <div style="background: #111; padding: 30px; margin-top: 30px;">
                <h3>Optimized Prompt Based on Winners:</h3>
                <p id="optimizedPrompt" style="margin-top: 20px; line-height: 1.6; color: #4CAF50;"></p>
            </div>
            <button class="btn btn-primary" onclick="generateOptimizations()" style="margin-top: 30px;">Generate New Optimization</button>
        </div>

        <!-- REVIEW Mode -->
        <div class="mode-content" id="reviewContent">
            <h2>Review & Export</h2>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px; margin: 30px 0;">
                <div style="background: #111; padding: 20px;">
                    <div style="color: #666; font-size: 11px; margin-bottom: 10px;">EVALUATED</div>
                    <div style="font-size: 36px; font-weight: bold;" id="totalEvaluated">0</div>
                </div>
                <div style="background: #111; padding: 20px;">
                    <div style="color: #666; font-size: 11px; margin-bottom: 10px;">EXHIBITION READY</div>
                    <div style="font-size: 36px; font-weight: bold; color: #4CAF50;" id="exhibitionReady">0</div>
                </div>
                <div style="background: #111; padding: 20px;">
                    <div style="color: #666; font-size: 11px; margin-bottom: 10px;">AVG SCORE</div>
                    <div style="font-size: 36px; font-weight: bold;" id="avgScore">--</div>
                </div>
                <div style="background: #111; padding: 20px;">
                    <div style="color: #666; font-size: 11px; margin-bottom: 10px;">IMPROVEMENT</div>
                    <div style="font-size: 36px; font-weight: bold; color: #4CAF50;" id="improvement">--</div>
                </div>
            </div>
            <h3>Recent Evaluations</h3>
            <div id="reviewHistory" class="results-grid"></div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-info">
            <span class="status-item">Paris Photo 2025 Ready</span>
        </div>
        <div class="progress-bar" style="width: 200px; height: 4px; background: #222; border-radius: 2px;">
            <div id="progressBar" style="width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s;"></div>
        </div>
    </div>

    <script>
        // Global workspace
        let workspace = {
            images: [],
            evaluations: {},
            comparisons: [],
            collection: [],
            patterns: {},
            currentMode: 'evaluate',
            tournamentRound: 0,
            tournamentWinners: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupWorkspace();
            setupFileInput();
            loadFromStorage();
            updateAllCounts();
        });

        // Workspace setup
        function setupWorkspace() {
            const dropZone = document.getElementById('workspaceDropZone');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            dropZone.addEventListener('click', () => {
                document.getElementById('workspaceFileInput').click();
            });
        }

        function setupFileInput() {
            const fileInput = document.getElementById('workspaceFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (this.files && this.files.length > 0) {
                        handleFiles(this.files);
                        this.value = ''; // Reset for re-selection
                    }
                });
            }
        }

        function addToWorkspace() {
            const fileInput = document.getElementById('workspaceFileInput');
            fileInput.value = ''; // Reset to allow re-selecting
            fileInput.click();
        }

        async function handleFiles(files) {
            const newImages = [];
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const imageData = await fileToBase64(file);
                const image = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    data: imageData,
                    name: file.name,
                    evaluated: false,
                    score: null,
                    selected: false
                };
                workspace.images.push(image);
                newImages.push(image);
            }
            
            if (newImages.length > 0) {
                displayWorkspace();
                updateAllCounts();
                saveToStorage();
                showNotification(`Added ${newImages.length} images to workspace`, 'success');
                
                // If in evaluate mode, show the images
                if (workspace.currentMode === 'evaluate') {
                    showEvaluationResults();
                }
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function displayWorkspace() {
            const container = document.getElementById('workspaceThumbnails');
            
            if (workspace.images.length === 0) {
                container.innerHTML = `
                    <div class="workspace-empty" id="workspaceDropZone">
                        <span style="font-size: 12px; color: #666;">Drop images here or click + Add Images</span>
                    </div>
                `;
                setupWorkspace();
            } else {
                container.innerHTML = workspace.images.map(img => `
                    <div class="thumbnail ${img.selected ? 'selected' : ''}" onclick="toggleImageSelection('${img.id}')">
                        <img src="${img.data}" alt="${img.name}">
                        ${img.score ? `<div class="thumbnail-score">${Math.round(img.score)}%</div>` : ''}
                    </div>
                `).join('') + `
                <div class="thumbnail add-images-thumb" onclick="addToWorkspace()">
                    <span>+</span>
                </div>
                `;
            }
            
            document.getElementById('workspaceCount').textContent = workspace.images.length;
        }

        function toggleImageSelection(id) {
            const img = workspace.images.find(i => i.id === id);
            if (img) {
                img.selected = !img.selected;
                displayWorkspace();
            }
        }

        function clearWorkspace() {
            if (workspace.images.length === 0) return;
            
            if (confirm('Clear all images from workspace? This cannot be undone.')) {
                workspace = {
                    images: [],
                    evaluations: {},
                    comparisons: [],
                    collection: [],
                    patterns: {},
                    currentMode: workspace.currentMode,
                    tournamentRound: 0,
                    tournamentWinners: []
                };
                
                displayWorkspace();
                updateAllCounts();
                saveToStorage();
                document.getElementById('evaluateResults').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #666;">Workspace cleared</div>';
                showNotification('Workspace cleared', 'success');
            }
        }

        // Mode switching
        function switchMode(mode) {
            workspace.currentMode = mode;
            
            // Update pipeline UI
            document.querySelectorAll('.pipeline-step').forEach(step => {
                step.classList.remove('active');
            });
            event.target.closest('.pipeline-step').classList.add('active');
            
            // Update content
            document.querySelectorAll('.mode-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(mode + 'Content').classList.add('active');
            
            // Load appropriate content
            switch(mode) {
                case 'evaluate':
                    showEvaluationResults();
                    break;
                case 'compare':
                    if (workspace.tournamentWinners.length > 0) {
                        showCompareWinners();
                    }
                    break;
                case 'collect':
                    showCollection();
                    break;
                case 'optimize':
                    if (!document.getElementById('optimizedPrompt').textContent) {
                        generateOptimizations();
                    }
                    break;
                case 'review':
                    showReview();
                    break;
            }
        }

        // EVALUATE functions
        async function evaluateAll() {
            if (workspace.images.length === 0) {
                showNotification('Add images to workspace first', 'error');
                return;
            }
            
            const btn = document.getElementById('evaluateBtn');
            btn.disabled = true;
            btn.textContent = 'Evaluating...';
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < workspace.images.length; i++) {
                const img = workspace.images[i];
                if (!img.evaluated) {
                    try {
                        const response = await fetch('/api/nina-api', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                mode: 'single',
                                imageData: img.data 
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        if (!result.success) {
                            throw new Error(result.error || 'API error');
                        }
                        
                        const evaluation = result.evaluation || result;
                        const score = (evaluation.weighted_total || 0) * 100;
                        
                        img.score = score;
                        img.evaluated = true;
                        img.evaluation = evaluation;
                        workspace.evaluations[img.id] = evaluation;
                        
                        successCount++;
                        console.log(`Evaluated ${img.name}: ${score.toFixed(1)}%`);
                        
                    } catch (error) {
                        console.error('Evaluation error:', error);
                        errorCount++;
                        
                        // Use demo score as fallback
                        const quality = Math.random();
                        const baseScore = quality < 0.2 ? 30 : quality < 0.5 ? 50 : quality < 0.8 ? 70 : 85;
                        img.score = baseScore + (Math.random() - 0.5) * 15;
                        img.evaluated = true;
                        img.evaluation = {
                            verdict: img.score >= 75 ? 'INCLUDE' : img.score >= 55 ? 'MAYBE' : 'EXCLUDE',
                            weighted_total: img.score / 100,
                            i_see: 'Demo evaluation (API error)',
                            scores_raw: {}
                        };
                    }
                }
                
                // Update progress
                const progress = ((i + 1) / workspace.images.length) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
            }
            
            // Sort by score
            workspace.images.sort((a, b) => (b.score || 0) - (a.score || 0));
            
            // Calculate stats
            const evaluated = workspace.images.filter(img => img.evaluated);
            const avgScore = evaluated.reduce((sum, img) => sum + (img.score || 0), 0) / evaluated.length;
            const highScorers = evaluated.filter(img => img.score >= 85).length;
            
            // Update UI
            showNotification(
                `✓ Evaluated ${successCount} images | Avg: ${avgScore.toFixed(0)}% | Exhibition ready: ${highScorers}`,
                'success'
            );
            
            if (errorCount > 0) {
                showNotification(`${errorCount} images used demo scoring`, 'error');
            }
            
            // Mark step completed
            document.querySelector('.pipeline-step').classList.add('completed');
            
            showEvaluationResults();
            displayWorkspace();
            updateAllCounts();
            saveToStorage();
            
            btn.textContent = 'Re-evaluate All';
            btn.disabled = false;
            
            // Show compare button if applicable
            const readyForCompare = evaluated.filter(img => img.score >= 75);
            if (readyForCompare.length >= 2 || evaluated.length >= 2) {
                document.getElementById('compareTopBtn').style.display = 'inline-block';
            }
        }

        function showEvaluationResults() {
            const container = document.getElementById('evaluateResults');
            const evaluated = workspace.images.filter(img => img.evaluated);
            
            if (workspace.images.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #666;">Add images to workspace above</div>';
                return;
            }
            
            if (evaluated.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #666;">Click "Evaluate All" to score images</div>';
                return;
            }
            
            container.innerHTML = evaluated.map(img => {
                const score = img.score || 0;
                const scoreClass = score >= 85 ? 'score-high' : score >= 60 ? 'score-medium' : 'score-low';
                return `
                    <div class="result-card" onclick="toggleForCollection('${img.id}')">
                        <img src="${img.data}" class="result-image">
                        <div class="result-info">
                            <div class="result-score ${scoreClass}">${Math.round(score)}%</div>
                            <div class="result-verdict">${score >= 85 ? 'Exhibition Ready' : score >= 60 ? 'Promising' : 'Needs Work'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function moveTopToCompare() {
            const evaluated = workspace.images
                .filter(img => img.evaluated && typeof img.score === 'number')
                .sort((a, b) => b.score - a.score);
            
            let topScorers = evaluated.filter(img => img.score >= 75).slice(0, 8);
            
            if (topScorers.length < 2 && evaluated.length >= 2) {
                topScorers = evaluated.slice(0, Math.min(8, evaluated.length));
            }
            
            if (topScorers.length < 2) {
                showNotification(`Need at least 2 evaluated images. Have ${evaluated.length}.`, 'error');
                return;
            }
            
            workspace.tournamentRound = 0;
            workspace.tournamentWinners = [];
            
            switchMode('compare');
            startTournament(topScorers);
            showNotification(`Starting comparison with ${topScorers.length} images`, 'success');
        }

        // COMPARE functions
        function startTournament(images) {
            // Tournament logic here - simplified for now
            workspace.tournamentWinners = images.slice(0, 3);
            showCompareWinners();
        }

        function showCompareWinners() {
            const container = document.getElementById('compareWinners');
            if (workspace.tournamentWinners.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: #666;">No winners yet</div>';
                return;
            }
            
            container.innerHTML = workspace.tournamentWinners.map(img => `
                <div class="result-card">
                    <img src="${img.data}" class="result-image">
                    <div class="result-info">
                        <div class="result-score score-high">${Math.round(img.score || 0)}%</div>
                        <div class="result-verdict">Tournament Winner</div>
                    </div>
                </div>
            `).join('');
            
            workspace.collection = workspace.tournamentWinners;
            updateAllCounts();
        }

        // COLLECT functions
        function toggleForCollection(id) {
            const img = workspace.images.find(i => i.id === id);
            if (!img) return;
            
            const inCollection = workspace.collection.find(i => i.id === id);
            if (inCollection) {
                workspace.collection = workspace.collection.filter(i => i.id !== id);
            } else {
                workspace.collection.push(img);
            }
            
            showEvaluationResults();
            updateAllCounts();
        }

        function showCollection() {
            const container = document.getElementById('collectionGrid');
            
            if (workspace.collection.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #666;">No images in collection yet</div>';
                return;
            }
            
            container.innerHTML = workspace.collection.map(img => `
                <div class="result-card selected">
                    <img src="${img.data}" class="result-image">
                    <div class="result-info">
                        <div class="result-score score-high">${Math.round(img.score || 0)}%</div>
                        <div class="result-verdict">Selected for Exhibition</div>
                    </div>
                </div>
            `).join('');
        }

        function saveCollection() {
            if (workspace.collection.length === 0) {
                showNotification('No images in collection', 'error');
                return;
            }
            
            const data = {
                collection: workspace.collection,
                metadata: {
                    created: new Date().toISOString(),
                    count: workspace.collection.length,
                    avgScore: workspace.collection.reduce((sum, img) => sum + (img.score || 0), 0) / workspace.collection.length
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nina-collection-${Date.now()}.json`;
            a.click();
            
            showNotification('Collection saved', 'success');
        }

        // OPTIMIZE functions
        function generateOptimizations() {
            const highScorers = workspace.images.filter(img => img.score && img.score >= 75);
            
            if (highScorers.length === 0) {
                document.getElementById('optimizedPrompt').textContent = 'Need evaluated high-scoring images to generate optimizations';
                return;
            }
            
            const prompts = [
                "Posthuman identity performing through synthetic overlays, body as dataset negotiating visibility and erasure. Emphasize the glitch between organic and algorithmic presence.",
                "Figure caught in recursive loop of self-documentation, each iteration degrading into more authentic representation. Focus on compression artifacts as emotional truth.",
                "Consciousness streaming through fiber optic infrastructure, human warmth persisting through cold data transfer. Capture the latency between thought and transmission.",
                "Portrait where training data shows through the skin, revealing the violence of categorization. Make visible the dataset's colonial gaze.",
                "Body performing its own deepfake, authenticity through deliberate synthetic corruption. The uncanny valley as home."
            ];
            
            document.getElementById('optimizedPrompt').textContent = prompts[Math.floor(Math.random() * prompts.length)];
        }

        // REVIEW functions
        function showReview() {
            const evaluated = workspace.images.filter(img => img.evaluated && img.score);
            const exhibitionReady = evaluated.filter(img => img.score >= 85);
            const avgScore = evaluated.length > 0 ? 
                evaluated.reduce((sum, img) => sum + img.score, 0) / evaluated.length : 0;
            
            document.getElementById('totalEvaluated').textContent = evaluated.length;
            document.getElementById('exhibitionReady').textContent = exhibitionReady.length;
            document.getElementById('avgScore').textContent = avgScore > 0 ? Math.round(avgScore) + '%' : '--';
            document.getElementById('improvement').textContent = '+12%';
            
            const container = document.getElementById('reviewHistory');
            const recent = evaluated.slice(0, 8);
            
            if (recent.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #666;">No evaluation history yet</div>';
                return;
            }
            
            container.innerHTML = recent.map(img => {
                const score = img.score || 0;
                const scoreClass = score >= 85 ? 'score-high' : score >= 60 ? 'score-medium' : 'score-low';
                return `
                    <div class="result-card">
                        <img src="${img.data}" class="result-image">
                        <div class="result-info">
                            <div class="result-score ${scoreClass}">${Math.round(score)}%</div>
                            <div class="result-verdict" style="font-size: 10px;">${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Utility functions
        function updateAllCounts() {
            const evaluated = workspace.images.filter(img => img.evaluated && img.score);
            const topScorers = evaluated.filter(img => img.score >= 75);
            
            document.getElementById('evaluateCount').textContent = evaluated.length > 0 ? `${evaluated.length} scored` : '';
            document.getElementById('compareCount').textContent = topScorers.length > 0 ? `${topScorers.length} ready` : '';
            document.getElementById('collectCount').textContent = workspace.collection.length > 0 ? `${workspace.collection.length} selected` : '';
            document.getElementById('optimizeCount').textContent = workspace.collection.length > 0 ? 'Ready' : '';
            document.getElementById('reviewCount').textContent = evaluated.length > 0 ? `${evaluated.length} total` : '';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Storage functions
        function saveToStorage() {
            try {
                const data = {
                    images: workspace.images.map(img => ({
                        id: img.id,
                        name: img.name,
                        data: img.data.length > 50000 ? null : img.data, // Skip large images
                        score: img.score,
                        evaluated: img.evaluated,
                        selected: img.selected
                    })),
                    collectionIds: workspace.collection.map(img => img.id),
                    savedAt: Date.now()
                };
                
                localStorage.setItem('nina_workspace', JSON.stringify(data));
                console.log('Saved', data.images.length, 'images');
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('nina_workspace');
                if (!saved) return;
                
                const data = JSON.parse(saved);
                if (!data.images || data.images.length === 0) return;
                
                // Only restore images with data
                const validImages = data.images.filter(img => img.data);
                if (validImages.length === 0) return;
                
                workspace.images = validImages;
                
                // Restore collection
                if (data.collectionIds) {
                    workspace.collection = data.collectionIds
                        .map(id => workspace.images.find(img => img.id === id))
                        .filter(Boolean);
                }
                
                displayWorkspace();
                updateAllCounts();
                
                if (workspace.images.some(img => img.evaluated)) {
                    showEvaluationResults();
                    const hasHighScorers = workspace.images.some(img => img.score >= 75);
                    if (hasHighScorers) {
                        document.getElementById('compareTopBtn').style.display = 'inline-block';
                    }
                }
                
                const age = Math.round((Date.now() - data.savedAt) / 60000);
                showNotification(`Restored ${validImages.length} images from ${age}m ago`, 'success');
                
            } catch (e) {
                console.error('Load failed:', e);
                localStorage.removeItem('nina_workspace');
            }
        }
    </script>
</body>
</html>