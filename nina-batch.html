<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NINA ROEHRS | BATCH CURATOR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #000;
            color: #fff;
            padding: 40px;
            line-height: 1.4;
        }

        h1 {
            font-size: 36px;
            font-weight: bold;
            letter-spacing: -1px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 12px;
            color: #888;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #444;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #fff;
            background: #111;
        }

        .upload-area.dragover {
            border-color: #0ff;
            background: #001122;
        }

        .upload-text {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .upload-count {
            font-size: 24px;
            font-weight: bold;
            color: #0ff;
            margin-top: 10px;
        }

        /* Control Panel */
        .control-panel {
            display: none;
            background: #111;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .control-panel.visible {
            display: block;
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 12px 30px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #0ff;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: transparent;
            color: #fff;
            border: 2px solid #fff;
        }

        .btn.secondary:hover {
            background: #fff;
            color: #000;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin-bottom: 30px;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
        }

        .progress-bar {
            height: 4px;
            background: #333;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #00ff00);
            transition: width 0.3s;
        }

        .current-file {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        /* Sort Controls */
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-select {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 8px 15px;
            font-size: 12px;
            text-transform: uppercase;
        }

        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .image-card {
            background: #111;
            border: 1px solid #333;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .image-card:hover {
            border-color: #0ff;
            transform: translateY(-5px);
        }

        .image-card.selected {
            border-color: #0ff;
            border-width: 2px;
        }

        .rank-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #000;
            color: #fff;
            padding: 5px 10px;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
            border: 2px solid #fff;
        }

        .rank-badge.gold {
            background: #ffd700;
            color: #000;
        }

        .rank-badge.silver {
            background: #c0c0c0;
            color: #000;
        }

        .rank-badge.bronze {
            background: #cd7f32;
            color: #fff;
        }

        .image-container {
            position: relative;
            padding-bottom: 100%; /* 1:1 aspect ratio */
            background: #000;
        }

        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-info {
            padding: 15px;
        }

        .card-filename {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-score {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-hint {
            display: inline-block;
            padding: 3px 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .card-hint.include {
            background: #0f0;
            color: #000;
        }

        .card-hint.borderline {
            background: #ff0;
            color: #000;
        }

        .card-hint.exclude {
            background: #f00;
            color: #fff;
        }

        .card-title {
            font-size: 14px;
            font-style: italic;
            color: #ccc;
            margin-bottom: 10px;
        }

        .dimension-mini {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #888;
            padding: 3px 0;
            border-bottom: 1px solid #222;
        }

        .dimension-mini:last-child {
            border-bottom: none;
        }

        .dimension-mini-score {
            color: #fff;
            font-weight: bold;
        }

        /* Statistics Panel */
        .stats-panel {
            display: none;
            background: #111;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .stats-panel.visible {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #000;
            padding: 20px;
            border-left: 4px solid #0ff;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        /* Export Options */
        .export-panel {
            display: none;
            background: #111;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #333;
        }

        .export-panel.visible {
            display: block;
        }

        /* Modal for detailed view */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px;
        }

        .modal.visible {
            display: block;
        }

        .modal-content {
            max-width: 1200px;
            margin: 0 auto;
            background: #111;
            padding: 40px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #fff;
        }

        .modal-close:hover {
            color: #0ff;
        }

        .modal-image {
            max-width: 100%;
            margin-bottom: 30px;
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid #333;
            border-top: 2px solid #0ff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        input[type="file"] {
            display: none;
        }

        /* Filter buttons */
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 20px;
            background: transparent;
            color: #888;
            border: 1px solid #444;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #0ff;
            color: #000;
            border-color: #0ff;
        }

        .filter-btn:hover {
            border-color: #0ff;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>NINA ROEHRS | BATCH CURATOR</h1>
    <div class="subtitle">Paris Photo Digital Section - Batch Evaluation System</div>

    <!-- Upload Area -->
    <div class="upload-area" id="uploadArea">
        <div class="upload-text">Drop Multiple Images or Click to Select</div>
        <div style="font-size: 12px; color: #666; margin-top: 10px;">
            Supports: JPG, PNG, WebP | Max 50 images per batch
        </div>
        <div class="upload-count" id="uploadCount"></div>
    </div>
    <input type="file" id="fileInput" accept="image/*" multiple>

    <!-- Control Panel -->
    <div class="control-panel" id="controlPanel">
        <div class="controls">
            <button class="btn" id="evaluateBtn">Evaluate All Images</button>
            <button class="btn secondary" id="clearBtn">Clear All</button>
            <div class="sort-controls">
                <label style="font-size: 12px; text-transform: uppercase;">Sort by:</label>
                <select class="sort-select" id="sortSelect">
                    <option value="score">Final Score</option>
                    <option value="conceptual">Conceptual Alignment</option>
                    <option value="dataset">Dataset Reflexivity</option>
                    <option value="aesthetic">Aesthetic Authority</option>
                    <option value="exhibition">Exhibition Presence</option>
                    <option value="risk">Risk Factor</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-header">
            <span>Evaluating Images</span>
            <span id="progressText">0 / 0</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="current-file" id="currentFile"></div>
    </div>

    <!-- Statistics Panel -->
    <div class="stats-panel" id="statsPanel">
        <h2 style="margin-bottom: 20px; font-size: 20px;">BATCH STATISTICS</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total Images</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statInclude">0</div>
                <div class="stat-label">Include (â‰¥82)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statBorderline">0</div>
                <div class="stat-label">Borderline (72-81)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statExclude">0</div>
                <div class="stat-label">Exclude (<72)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAverage">0</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>
        
        <!-- Z-Score Distribution -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;">
            <h3 style="font-size: 16px; margin-bottom: 15px;">SCORE DISTRIBUTION</h3>
            <canvas id="distributionChart" width="100%" height="150" style="background: #111; border: 1px solid #333;"></canvas>
            <div id="zScoreInfo" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div class="stat-card" style="background: #0a0a0a;">
                    <div class="stat-value" id="zMean" style="font-size: 18px;">0</div>
                    <div class="stat-label" style="font-size: 10px;">Mean Score</div>
                </div>
                <div class="stat-card" style="background: #0a0a0a;">
                    <div class="stat-value" id="zStdDev" style="font-size: 18px;">0</div>
                    <div class="stat-label" style="font-size: 10px;">Std Deviation</div>
                </div>
                <div class="stat-card" style="background: #0a0a0a;">
                    <div class="stat-value" id="zRange" style="font-size: 18px;">0</div>
                    <div class="stat-label" style="font-size: 10px;">Score Range</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons" id="filterButtons" style="display: none;">
        <button class="filter-btn active" data-filter="all">All Images</button>
        <button class="filter-btn" data-filter="include">Include Only</button>
        <button class="filter-btn" data-filter="borderline">Borderline</button>
        <button class="filter-btn" data-filter="exclude">Exclude</button>
    </div>

    <!-- Results Grid -->
    <div class="results-grid" id="resultsGrid"></div>

    <!-- Export Panel -->
    <div class="export-panel" id="exportPanel">
        <h2 style="margin-bottom: 20px; font-size: 20px;">EXPORT RESULTS</h2>
        <div class="controls">
            <button class="btn" id="exportJsonBtn">Export as JSON</button>
            <button class="btn" id="exportCsvBtn">Export as CSV</button>
            <button class="btn secondary" id="copyTopBtn">Copy Top 10 Filenames</button>
        </div>
    </div>

    <!-- Modal for Detailed View -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // State
        let uploadedFiles = [];
        let evaluationResults = [];
        let isEvaluating = false;
        let currentFilter = 'all';

        // Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadCount = document.getElementById('uploadCount');
        const controlPanel = document.getElementById('controlPanel');
        const evaluateBtn = document.getElementById('evaluateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const currentFile = document.getElementById('currentFile');
        const resultsGrid = document.getElementById('resultsGrid');
        const statsPanel = document.getElementById('statsPanel');
        const exportPanel = document.getElementById('exportPanel');
        const sortSelect = document.getElementById('sortSelect');
        const filterButtons = document.getElementById('filterButtons');
        const detailModal = document.getElementById('detailModal');
        const modalClose = document.getElementById('modalClose');
        const modalBody = document.getElementById('modalBody');

        // Upload Handlers
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            const imageFiles = Array.from(files).filter(file => 
                file.type.startsWith('image/')
            ).slice(0, 50); // Max 50 files

            if (imageFiles.length === 0) return;

            uploadedFiles = imageFiles;
            uploadCount.textContent = `${uploadedFiles.length} images selected`;
            uploadCount.style.display = 'block';
            controlPanel.classList.add('visible');
        }

        // Evaluate Button
        evaluateBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0 || isEvaluating) return;

            isEvaluating = true;
            evaluateBtn.disabled = true;
            progressContainer.classList.add('visible');
            evaluationResults = [];
            resultsGrid.innerHTML = '';
            statsPanel.classList.remove('visible');
            exportPanel.classList.remove('visible');
            filterButtons.style.display = 'none';

            for (let i = 0; i < uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                progressText.textContent = `${i + 1} / ${uploadedFiles.length}`;
                progressFill.style.width = `${((i + 1) / uploadedFiles.length) * 100}%`;
                currentFile.textContent = `Currently evaluating: ${file.name}`;

                try {
                    const compressedImage = await compressImage(file);
                    const result = await evaluateImage(compressedImage, file.name);
                    evaluationResults.push(result);
                } catch (error) {
                    console.error(`Failed to evaluate ${file.name}:`, error);
                    evaluationResults.push({
                        filename: file.name,
                        error: true,
                        finalScore: 0,
                        rankHint: 'exclude'
                    });
                }
            }

            // Sort by score
            evaluationResults.sort((a, b) => b.finalScore - a.finalScore);

            // Display results
            displayResults();
            displayStatistics();

            progressContainer.classList.remove('visible');
            statsPanel.classList.add('visible');
            exportPanel.classList.add('visible');
            filterButtons.style.display = 'flex';
            isEvaluating = false;
            evaluateBtn.disabled = false;
        });

        // Clear Button
        clearBtn.addEventListener('click', () => {
            uploadedFiles = [];
            evaluationResults = [];
            uploadCount.textContent = '';
            uploadCount.style.display = 'none';
            controlPanel.classList.remove('visible');
            progressContainer.classList.remove('visible');
            resultsGrid.innerHTML = '';
            statsPanel.classList.remove('visible');
            exportPanel.classList.remove('visible');
            filterButtons.style.display = 'none';
            fileInput.value = '';
        });

        // Compress Image
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxSize = 1024;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve({
                            dataUrl: canvas.toDataURL('image/jpeg', 0.85),
                            originalDataUrl: e.target.result
                        });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Evaluate Single Image
        async function evaluateImage(imageData, filename) {
            try {
                const response = await fetch('http://localhost:3001/api/nina-curator-v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: imageData.dataUrl,
                        mode: 'single'
                    })
                });

                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }

                const result = await response.json();
                
                // Handle v2 API response format
                if (result.success && result.evaluation) {
                    const eval = result.evaluation;
                    return {
                        filename,
                        imageData: imageData.originalDataUrl,
                        i_see: eval.i_see,
                        gate: eval.gate,
                        scores_raw: eval.scores_raw,
                        rationales: eval.rationales,
                        weighted_total: eval.weighted_total,
                        verdict: eval.verdict,
                        flags: eval.flags,
                        confidence: eval.confidence,
                        nina_pick: eval.nina_pick,
                        finalScore: eval.weighted_total * 100,
                        rankHint: eval.verdict.toLowerCase(),
                        dimensions: eval.scores_raw // Map to old format
                    };
                } else if (result.success && result.ninaEvaluation) {
                    // Fallback to old format
                    return {
                        filename,
                        imageData: imageData.originalDataUrl,
                        ...result.ninaEvaluation
                    };
                }
                
                throw new Error('Evaluation failed');
                
            } catch (error) {
                console.error(`Failed to evaluate ${filename}:`, error);
                return {
                    filename,
                    imageData: imageData.originalDataUrl,
                    error: true,
                    finalScore: 0,
                    rankHint: 'exclude',
                    titleSuggestion: 'Evaluation Failed',
                    dimensions: {}
                };
            }
        }

        // Display Results
        function displayResults() {
            resultsGrid.innerHTML = '';
            
            let displayResults = evaluationResults;
            
            // Apply filter
            if (currentFilter !== 'all') {
                displayResults = evaluationResults.filter(r => {
                    // Handle both old and new formats
                    const hint = r.verdict ? r.verdict.toLowerCase() : r.rankHint;
                    return hint === currentFilter;
                });
            }

            // Apply sort
            const sortBy = sortSelect.value;
            displayResults = [...displayResults].sort((a, b) => {
                if (sortBy === 'score') return b.finalScore - a.finalScore;
                if (sortBy === 'conceptual') return (b.scores_raw?.conceptual_strength || 0) - (a.scores_raw?.conceptual_strength || 0);
                if (sortBy === 'dataset') return (b.scores_raw?.ai_criticality || 0) - (a.scores_raw?.ai_criticality || 0);
                if (sortBy === 'aesthetic') return (b.scores_raw?.technical_excellence || 0) - (a.scores_raw?.technical_excellence || 0);
                if (sortBy === 'exhibition') return (b.scores_raw?.paris_photo_ready || 0) - (a.scores_raw?.paris_photo_ready || 0);
                if (sortBy === 'risk') return (b.scores_raw?.cultural_dialogue || 0) - (a.scores_raw?.cultural_dialogue || 0);
                return 0;
            });

            displayResults.forEach((result, index) => {
                const card = createImageCard(result, index + 1);
                resultsGrid.appendChild(card);
            });
        }

        // Create Image Card
        function createImageCard(result, rank) {
            const card = document.createElement('div');
            card.className = 'image-card';
            
            let rankBadgeClass = '';
            if (rank === 1) rankBadgeClass = 'gold';
            else if (rank === 2) rankBadgeClass = 'silver';
            else if (rank === 3) rankBadgeClass = 'bronze';

            card.innerHTML = `
                <div class="rank-badge ${rankBadgeClass}">#${rank}</div>
                <div class="image-container">
                    <img src="${result.imageData}" alt="${result.filename}">
                </div>
                <div class="card-info">
                    <div class="card-filename">${result.filename}</div>
                    <div class="card-score">${Math.round(result.finalScore)}/100</div>
                    <div class="card-hint ${result.rankHint}">${result.verdict || result.rankHint}</div>
                    ${result.i_see ? `<div class="card-description" style="font-size: 10px; color: #aaa; margin: 5px 0; font-style: italic;">${result.i_see.substring(0, 100)}...</div>` : ''}
                    ${result.scores_raw ? `
                        <div style="margin-top: 10px;">
                            <div class="dimension-mini">
                                <span>Paris Photo</span>
                                <span class="dimension-mini-score">${result.scores_raw.paris_photo_ready || 0}</span>
                            </div>
                            <div class="dimension-mini">
                                <span>AI-Critical</span>
                                <span class="dimension-mini-score">${result.scores_raw.ai_criticality || 0}</span>
                            </div>
                            <div class="dimension-mini">
                                <span>Conceptual</span>
                                <span class="dimension-mini-score">${result.scores_raw.conceptual_strength || 0}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            card.addEventListener('click', () => showDetailModal(result));
            return card;
        }

        // Display Statistics
        function displayStatistics() {
            const total = evaluationResults.length;
            const include = evaluationResults.filter(r => {
                const hint = r.verdict ? r.verdict.toLowerCase() : r.rankHint;
                return hint === 'include';
            }).length;
            const borderline = evaluationResults.filter(r => {
                const hint = r.verdict ? r.verdict.toLowerCase() : r.rankHint;
                return hint === 'maybe' || hint === 'borderline';
            }).length;
            const exclude = evaluationResults.filter(r => {
                const hint = r.verdict ? r.verdict.toLowerCase() : r.rankHint;
                return hint === 'exclude';
            }).length;
            const scores = evaluationResults.map(r => r.finalScore);
            const average = Math.round(scores.reduce((sum, s) => sum + s, 0) / total);
            
            // Calculate z-score statistics
            const mean = scores.reduce((sum, s) => sum + s, 0) / scores.length;
            const variance = scores.reduce((sum, s) => sum + Math.pow(s - mean, 2), 0) / scores.length;
            const stdDev = Math.sqrt(variance);
            const range = Math.max(...scores) - Math.min(...scores);

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statInclude').textContent = include;
            document.getElementById('statBorderline').textContent = borderline;
            document.getElementById('statExclude').textContent = exclude;
            document.getElementById('statAverage').textContent = average;
            
            // Update z-score info
            document.getElementById('zMean').textContent = mean.toFixed(1);
            document.getElementById('zStdDev').textContent = stdDev.toFixed(1);
            document.getElementById('zRange').textContent = range.toFixed(0);
            
            // Draw distribution chart
            drawDistributionChart(scores);
        }
        
        // Draw score distribution chart
        function drawDistributionChart(scores) {
            const canvas = document.getElementById('distributionChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Create histogram bins
            const binCount = 10;
            const min = Math.min(...scores);
            const max = Math.max(...scores);
            const binSize = (max - min) / binCount;
            const bins = new Array(binCount).fill(0);
            
            scores.forEach(score => {
                const binIndex = Math.min(Math.floor((score - min) / binSize), binCount - 1);
                bins[binIndex]++;
            });
            
            const maxBin = Math.max(...bins);
            const barWidth = width / binCount;
            
            // Draw bars
            ctx.fillStyle = '#4CAF50';
            bins.forEach((count, i) => {
                const barHeight = (count / maxBin) * (height - 20);
                const x = i * barWidth;
                const y = height - barHeight;
                
                // Color based on score range
                const binScore = min + (i * binSize);
                if (binScore >= 80) ctx.fillStyle = '#4CAF50';
                else if (binScore >= 65) ctx.fillStyle = '#FF9800';
                else ctx.fillStyle = '#f44336';
                
                ctx.fillRect(x, y, barWidth - 2, barHeight);
            });
            
            // Draw axis
            ctx.strokeStyle = '#666';
            ctx.beginPath();
            ctx.moveTo(0, height - 1);
            ctx.lineTo(width, height - 1);
            ctx.stroke();
        }

        // Sort Handler
        sortSelect.addEventListener('change', displayResults);

        // Filter Handlers
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                displayResults();
            });
        });

        // Export Functions
        document.getElementById('exportJsonBtn').addEventListener('click', () => {
            const data = evaluationResults.map((r, i) => ({
                rank: i + 1,
                filename: r.filename,
                finalScore: r.finalScore,
                rankHint: r.rankHint,
                titleSuggestion: r.titleSuggestion,
                dimensions: r.dimensions,
                tensionAnalysis: r.tensionAnalysis,
                wallLabel: r.wallLabel,
                curatorNotes: r.curatorNotes
            }));

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nina-evaluation-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        });

        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            let csv = 'Rank,Filename,Final Score,Rank Hint,Title,Conceptual,Dataset,Portrait,Aesthetic,Exhibition\n';
            
            evaluationResults.forEach((r, i) => {
                csv += `${i + 1},"${r.filename}",${r.finalScore},${r.rankHint},"${r.titleSuggestion || ''}",`;
                csv += `${r.dimensions?.conceptualAlignment?.score || 0},`;
                csv += `${r.dimensions?.datasetReflexivity?.score || 0},`;
                csv += `${r.dimensions?.portraitInnovation?.score || 0},`;
                csv += `${r.dimensions?.aestheticAuthority?.score || 0},`;
                csv += `${r.dimensions?.exhibitionPresence?.score || 0}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nina-evaluation-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });

        document.getElementById('copyTopBtn').addEventListener('click', () => {
            const top10 = evaluationResults.slice(0, 10).map(r => r.filename).join('\n');
            navigator.clipboard.writeText(top10).then(() => {
                alert('Top 10 filenames copied to clipboard!');
            });
        });

        // Modal Functions
        function showDetailModal(result) {
            modalBody.innerHTML = `
                <h2>${result.titleSuggestion || 'Untitled'}</h2>
                <p style="color: #888; margin-bottom: 20px;">${result.filename}</p>
                <img src="${result.imageData}" class="modal-image" alt="${result.filename}">
                
                <div style="font-size: 48px; font-weight: bold; margin-bottom: 20px;">
                    ${result.finalScore}/100
                    <span class="card-hint ${result.rankHint}" style="font-size: 16px; margin-left: 20px;">${result.rankHint}</span>
                </div>

                ${result.wallLabel ? `
                    <div style="background: #fff; color: #000; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">Wall Label</h3>
                        <p style="line-height: 1.6;">${result.wallLabel}</p>
                    </div>
                ` : ''}

                ${result.curatorNotes ? `
                    <div style="background: #222; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">Curator Notes</h3>
                        <p style="line-height: 1.6; color: #ccc;">${result.curatorNotes}</p>
                    </div>
                ` : ''}

                <h3 style="margin-bottom: 15px;">Dimension Scores</h3>
                ${Object.entries(result.dimensions || {}).map(([key, data]) => `
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${key.replace(/([A-Z])/g, ' $1').trim()}</strong>
                            <strong>${data.score || 0}/100</strong>
                        </div>
                        <div style="color: #888; font-size: 14px;">${data.rationale || ''}</div>
                    </div>
                `).join('')}
            `;

            detailModal.classList.add('visible');
        }

        modalClose.addEventListener('click', () => {
            detailModal.classList.remove('visible');
        });

        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                detailModal.classList.remove('visible');
            }
        });
    </script>
</body>
</html>